\input{draftfinal.tex} % separate file cos it's gonna change frequently
\documentclass[USenglish,\classoptions,\draftfinal]{memoir}
\usepackage{ifdraft}

\usepackage{mathtools}    %loads amsmath. equation env has funny spacing with hyperref :-( so...
\let\equation\gather \let\endequation\endgather
\usepackage[version=3]{mhchem} %Chemical formula
\usepackage{amssymb}
\usepackage{dsfont}
\usepackage{mathspec} %loads fontspec
\setromanfont[Ligatures={TeX, Common}, Numbers=OldStyle]{Skolar PE}
%\setmainfont[RawFeature={+ss02,+cv01,+ss05,+dlig},ItalicFeatures={RawFeature=+cv04,CharacterVariant=5:2}]{EB Garamond} %Good for old school s
\setsansfont{Idealist Sans}
\setmonofont{PragmataPro}
%\defaultfontfeatures{ Scale = MatchLowercase }
\setmathsfont(Digits,Latin,Greek)[Numbers={Lining,Proportional}]{Minion Pro}
\setmathrm{Minion Pro}
\usepackage{fix-cm} %Computer Modern is used in a few places and throws errors.
\usepackage{ragged2e}  % load early, so things pick it up. [newcommands] to replace old ver

\usepackage{xunicode} %Extra unicode options for xetex
\usepackage{babel}
\usepackage{eqparbox}
\usepackage[rgb]{xcolor}
\usepackage[mode=buildmissing]{standalone} %TODO: buildnew doesn't work for xelatex. Find out what to do with this.
\usepackage{tikz}
\usepackage{pgfplots}
\pgfplotsset{compat=1.10}
\usepgfplotslibrary{colorbrewer}
\input{tikzmark.tex}

\usepackage{url}
\urlstyle{rm}
\usepackage[sort&compress,mcite]{natbib}
\usepackage{bibentry} % for permissions
%choose cite formatting:
\renewcommand*{\citenumfont}[1]{\addfontfeature{Numbers=Lining}{#1}} % oldstyle looks wrong to me in brackets. TODO: This isn't fixing the issue
\citestyle{plain}           % numbers in square brackets
%\citestyle{nature}         % superscript.
%choose a number formatting for the biblist:
\renewcommand*{\bibnumfmt}[1]{\eqparbox[t]{bblnm}{\hfill#1.}}
\usepackage{bibunitsLSB}    % a problematic package. maybe matters whether before/after natbib?

% Thesis-specific formatting
\ifdblspc\OnehalfSpacing % before geometry, so that heightrounded works right.
\else
\newenvironment{SingleSpace}{}{}
\newenvironment{SingleSpace*}{}{}
\fi
\usepackage[\geomoptions]{geometry} % showframe?

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% FORMATTING
% I have lots of big figures, so allow pages with only a few lines of text
\renewcommand{\topfraction}{0.9}
\renewcommand{\bottomfraction}{0.6}
\setcounter{topnumber}{2}
\setcounter{bottomnumber}{2}
\setcounter{totalnumber}{2}
\renewcommand{\textfraction}{0.07}
\renewcommand{\floatpagefraction}{0.7}
\renewcommand{\dblfloatpagefraction}{0.7}
% flushbottom is in principle better than raggedbottom for twoside, but my life is too short to try to make this kind of document (lots of figures, section headings, equations) layout properly in LaTeX with flushbottom. the stretchy topskip is a trick to get (slightly) better pagebreaks:
\widowpenalty=10000 \raggedbottom  \addtolength{\topskip}{0pt plus 10pt}
\usepackage{fnbreak}% warn about footnotes broken across pages, or:
%\interfootnotelinepenalty=10000 % ...prevent split footnotes completely

%Chapter headers
\input{header.tex}
\chapterstyle{voronoi}

%Section headers
\setsecheadstyle{\fontspec{Idealist Sans}\fontsize{15}{17}\selectfont}
\setsubsecheadstyle{\fontspec{Idealist Sans}\fontsize{13}{15}\selectfont}
\usepackage{emptypage} % no page numbers or headers on empty pages

%Figure captions
\captiondelim{--- }
\captionnamefont{\small\bfseries}
\captiontitlefont{\small}
\captionstyle{\centerlastline}
\changecaptionwidth
\captionwidth{0.925\textwidth}

%Header and footer styles
\nouppercaseheads
\copypagestyle{thesis}{headings}
\makeevenhead{thesis}{\addfontfeature{Numbers=Lining}{\thepage}}{}{\addfontfeature{LetterSpace=20.0,Letters=SmallCaps,Numbers=Lining}{\leftmark}}
\makeoddhead{thesis}{\addfontfeature{LetterSpace=20.0,Letters=SmallCaps,Numbers=Lining}{\rightmark}}{}{\addfontfeature{Numbers=Lining}{\thepage}}
\pagestyle{thesis}

%Table of Contents (And List of Figures)
\renewcommand{\cftchapterfont}{\bfseries\addfontfeature{LetterSpace=10.0}}
\renewcommand*{\cftchapterformatpnum}{\bfseries\large}
\renewcommand{\cftchapterpresnum}{\HUGE}
\renewcommand\cftchapteraftersnumb{\large\enspace\textperiodcentered\enspace}
\renewcommand\chapternumberlinebox[2]{#2}
\renewcommand{\cftfigureindent}{1.5em}

\newcommand{\lofchap}[1]{%alias for chapter headings in list of figures
    \addcontentsline{lof}{chapter}{\protect\numberline{\thechapter}#1}%
}

%TODO: wtf
\setlength{\unitlength}{22mm}
\newcommand{\doblob}{\rule[-.1\unitlength]{2\unitlength}{.5\unitlength}}
\newcommand{\rblob}{%
    \begin{picture}(0,0)
        \put(1.05,-\value{thumbcount}){\blob}
    \end{picture}}
\newcommand\lblob{%
    \begin{picture}(0,0)
        \put(-3.05,-\value{thumbcount}){\blob}
    \end{picture}
}
\newcounter{thumbcount}
\makeatletter
\newcommand\overview{}
\newcommand*{\listofthumbs}{%
    \cleardoublepage
    \thispagestyle{overview}%
    \@starttoc{thb}
    \mbox{}\newpage}
\makeatother
\newcommand*{\thumbwrite}[2]{\addtocontents{thb}{\string\thumbitem{#1}{#2}}}
\newcommand*{\thumbitem}[2]{\expandafter\gdef\expandafter\overview\expandafter{\overview
    \begin{picture}(0,0)
        \put(0.75,-#2){\llap{\Large{#1}}}
        \put(1.05,-#2){\doblob}
    \end{picture}}}
\newcommand*{\thumb}[1]{%
    \let\blob=\doblob
    \stepcounter{thumbcount}%
    \thumbwrite{#1}{\arabic{thumbcount}}}
\newcommand*{\nothumb}{\let\blob=\relax}
\nothumb
\newcounter{lframe}
\newcounter{rframe}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% VERSIONING/CHANGE TRACKING
\usepackage[shadow,obeyDraft,colorinlistoftodos,textsize=small]{todonotes}
\usepackage{fixme}
\newcommand*\timFXtodo[3]{\todo[caption={#2}]{\begin{SingleSpace}#2\end{SingleSpace}}}
\FXRegisterLayout*[marginclue,marginnote,margin]{todo}{\timFXtodo}
\fxsetup{todo}
\newcommand*{\xxx}[1]{\fxnote{#1}}
\newcommand*{\fixmelist}{\listoffixmes} % or listoftodos (nice color, missing figures)

%Additionals if we're in draft mode
\ifdraft{%
\usepackage[color,notref,notcite]{showkeys} % notref for cleverref compat
\usepackage[markifdraft]{gitinfo2}
%gitinfo2 cracks the sads if Idealist sans tries to print a colon. Altered the spec to compensate
\renewcommand{\gitMark}{Branch\fontspec{Skolar PE}{:}\fontspec{Idealist Sans}{ \gitBranch\,@\,\gitAbbrevHash{}
\textbullet{} (\gitAuthorDate)}}
}{} % ifdraft

%%%%%%%%%%%%%%%%%%%%%%
%% MICROTYPOGRAPHY
\usepackage[babel,final]{microtype}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% HYPERLINKS/PDF
%% these packages must come last:

%Make sure titles use \texorpdfstring
\usepackage[unicode,pdfencoding=auto,final,\hyperoptions,hyperfootnotes=false,linktoc=all,pagebackref]{hyperref}
\usepackage{backref}

%\usepackage[a-1b]{pdfxLSB} % some bugs fixed/worked around by LSB. don't forget to update
\let\oldphantomsection\phantomsection
% Set up back references:
    \backrefparscanfalse
    \newcommand{\backrefnotcitedstring}{\relax}%(Not cited.)
    \newcommand{\backrefcitedsinglestring}[1]{Cited on page~#1.}
    \newcommand{\backrefcitedmultistring} [1]{Cited on pages~#1.}
    \AtBeginDocument{% to override babel
        \renewcommand{\backreftwosep}{~\&~}    % seperate 2 pages
        \renewcommand{\backreflastsep}{~\&~}} % seperate last of longer list
    \renewcommand*{\backref}[1]{}  % Disable standard
    \renewcommand*{\backrefalt}[4]{% Detailed backref
      \ifcase #1\backrefnotcitedstring%
      \or\backrefcitedsinglestring{#2}%
      \else\backrefcitedmultistring{#2}%
      \fi}

\usepackage[english]{cleveref} % after hyperref
\crefname{equation}{}{equations}
\crefname{figure}{figure}{figures}
\crefformat{equation}{(#2#1#3)}
\Crefformat{equation}{Equation~(#2#1#3)}
\crefformat{appendix}{#2appendix~#1#3}
\Crefformat{appendix}{#2Appendix~#1#3}
\crefformat{chapter}{#2chapter~#1#3}
\Crefformat{chapter}{#2Chapter~#1#3}
\crefformat{section}{#2section~#1#3}
\Crefformat{section}{#2Section~#1#3}
\crefformat{figure}{#2figure~#1#3}
\Crefformat{figure}{#2Figure~#1#3}
\crefformat{table}{#2table~#1#3}
\Crefformat{table}{#2Table~#1#3}

% controversial: cancel resetting page numbers at end of \frontmatter, for easier pdf navigation:
\makeatletter
\def\pagenumbering#1{\gdef\thepage{\csname @#1\endcsname \c@page}}
\makeatother

\input{macros.tex} % shared so that psfrag for figures can use it

%% Extra stuff
\hyphenation{tri-methyl-aluminium}
